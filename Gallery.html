<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARMORY | TACTICAL OPS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="style.css" rel="stylesheet">
    <style>
        .comment-box {
            background: rgba(0,0,0,0.3);
            border-left: 2px solid var(--gold);
            padding: 10px;
            margin-bottom: 8px;
        }
        .comment-user { font-weight: bold; color: #fff; font-size: 0.9em; }
        .comment-text { color: #ccc; font-size: 0.85em; }
        .comment-date { font-size: 0.7em; color: #666; }
        .qr-container {
            background: white;
            padding: 15px;
            border-radius: 10px;
            display: inline-block;
            margin-top: 10px;
        }
    </style>
</head>
<body onload="initSystem()">
    <div class="bg-grid"></div>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-tactical fixed-top">
        <div class="container">
            <a class="navbar-brand brand-font text-gold" href="index.html">
                <i class="fas fa-shield-alt me-2"></i>TACTICAL<span class="text-white">OPS</span>
            </a>
            <button class="navbar-toggler btn-sm btn-outline-warning" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
                <i class="fas fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="mainNav">
                <ul class="navbar-nav ms-auto align-items-center gap-3" id="navAuth">
                    <li class="nav-item"><a class="nav-link" href="index.html">HOME</a></li>
                    <li class="nav-item"><a class="nav-link active text-gold" href="Gallery.html">ARMORY</a></li>
                    <li class="nav-item"><a class="nav-link" href="ABOUT.html">ABOUT</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- HEADER -->
    <header class="py-5 mt-5 text-center">
        <h1 class="font-military display-4 text-white text-shadow">ARMORY INVENTORY</h1>
        <p class="text-gold font-tech fs-5">EQUIP YOURSELF FOR THE MISSION</p>
    </header>

    <!-- FILTERS -->
    <div class="container mb-4 text-center">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-warning active" onclick="filterShop('ALL', this)">ALL</button>
            <button type="button" class="btn btn-outline-warning" onclick="filterShop('WEAPONS', this)">WEAPONS</button>
            <button type="button" class="btn btn-outline-warning" onclick="filterShop('ARMOR', this)">ARMOR</button>
            <button type="button" class="btn btn-outline-warning" onclick="filterShop('GEAR', this)">GEAR</button>
        </div>
    </div>

    <!-- PRODUCT GRID -->
    <div class="container pb-5 mb-5">
        <div class="row g-4" id="galleryGrid"></div>
    </div>

    <!-- PRODUCT DETAILS MODAL -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title font-military text-gold">TACTICAL SPECIFICATION</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-5 mb-3">
                            <img src="" id="modalImg" class="img-fluid rounded border border-secondary w-100" style="min-height: 250px; object-fit: cover;">
                        </div>
                        <div class="col-md-7">
                            <h3 class="font-tech text-white mb-1" id="modalName">ITEM NAME</h3>
                            <div class="mb-2">
                                <span class="badge bg-warning text-dark" id="modalCat">CATEGORY</span>
                                <span class="badge bg-secondary text-white ms-1" id="modalId">ID</span>
                            </div>
                            <h2 class="text-gold font-monospace mb-3" id="modalPrice">฿0</h2>
                            <div class="bg-black bg-opacity-50 p-3 rounded border border-secondary mb-3">
                                <h6 class="text-muted font-tech mb-2">DESCRIPTION</h6>
                                <p class="small mb-0 text-light" id="modalDesc">Loading intel...</p>
                            </div>
                            <div class="d-flex align-items-center mb-3">
                                <span class="me-3 font-tech text-muted">QUANTITY:</span>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="adjustModalQty(-1)"><i class="fas fa-minus"></i></button>
                                    <span class="btn btn-outline-secondary btn-sm disabled text-white fw-bold" style="width: 50px;" id="modalQtyDisplay">1</span>
                                    <button class="btn btn-outline-warning btn-sm" onclick="adjustModalQty(1)"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            <button class="btn btn-gold fw-bold py-2 w-100 mb-4" onclick="addToCartFromModal()">
                                <i class="fas fa-cart-plus me-2"></i> ADD TO LOADOUT
                            </button>
                            <div class="border-top border-secondary pt-3">
                                <h5 class="font-tech text-gold mb-3"><i class="fas fa-comments me-2"></i>OPERATIVE REVIEWS</h5>
                                <div id="commentsList" class="mb-3" style="max-height: 200px; overflow-y: auto;"></div>
                                <div class="input-group">
                                    <input type="text" id="commentInput" class="form-control bg-dark text-white border-secondary" placeholder="Write a field report...">
                                    <button class="btn btn-outline-gold" onclick="postComment()"><i class="fas fa-paper-plane"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CHECKOUT MODAL -->
    <div class="modal fade" id="checkoutModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-gold">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title font-military text-gold"><i class="fas fa-file-invoice-dollar me-2"></i>SECURE CHECKOUT</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="checkoutForm">
                        <h6 class="text-muted font-tech mb-3 border-bottom border-secondary pb-2">OPERATIVE INFO</h6>
                        <div class="mb-3">
                            <label class="form-label small text-gold">FULL NAME</label>
                            <input type="text" class="form-control bg-black text-white border-secondary" id="cName" required placeholder="John Doe">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-gold">PHONE NUMBER</label>
                            <input type="tel" class="form-control bg-black text-white border-secondary" id="cPhone" required placeholder="08x-xxx-xxxx">
                        </div>
                        <div class="mb-4">
                            <label class="form-label small text-gold">SHIPPING ADDRESS</label>
                            <textarea class="form-control bg-black text-white border-secondary" id="cAddr" rows="3" required placeholder="House No, Street, City, Zipcode"></textarea>
                        </div>
                        <h6 class="text-muted font-tech mb-3 border-bottom border-secondary pb-2">PAYMENT METHOD</h6>
                        <div class="mb-3">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="payCOD" value="COD" checked onchange="togglePayment()">
                                <label class="form-check-label" for="payCOD"><i class="fas fa-truck text-success me-2"></i>Cash On Delivery (COD)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="payQR" value="QR" onchange="togglePayment()">
                                <label class="form-check-label" for="payQR"><i class="fas fa-qrcode text-info me-2"></i>PromptPay QR Code</label>
                            </div>
                        </div>
                        <div id="qrDisplay" class="text-center mb-3" style="display: none;">
                            <div class="qr-container">
                                <img src="https://promptpay.io/0928198431.png" alt="PromptPay QR" class="img-fluid" style="width: 200px;">
                            </div>
                            <div class="mt-2 text-gold font-monospace">092-819-8431<br><small class="text-muted">(Scan with Bank App)</small></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-secondary">
                    <div class="d-flex justify-content-between w-100 align-items-center">
                        <span class="fs-5 fw-bold">TOTAL: <span id="checkoutTotal" class="text-gold">฿0</span></span>
                        <button type="button" class="btn btn-gold fw-bold px-4" onclick="confirmOrder()">CONFIRM ORDER</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Cart Button -->
    <button class="btn btn-gold rounded-circle shadow-lg position-fixed bottom-0 end-0 m-4 p-3 z-3" style="width: 60px; height: 60px;" data-bs-toggle="offcanvas" data-bs-target="#cartOffcanvas">
        <i class="fas fa-shopping-cart fa-lg"></i>
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger border border-dark" id="cartBadgeFloat">0</span>
    </button>

    <!-- Cart Offcanvas -->
    <div class="offcanvas offcanvas-end text-white" tabindex="-1" id="cartOffcanvas" style="background: #111;">
        <div class="offcanvas-header border-bottom border-secondary">
            <h5 class="offcanvas-title font-tech text-gold">CURRENT LOADOUT</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <div id="cartItems" class="mb-3"></div>
            <div class="border-top border-secondary pt-3">
                <div class="d-flex justify-content-between mb-3">
                    <span>TOTAL</span>
                    <span class="text-gold fw-bold" id="cartTotal">฿0</span>
                </div>
                <button onclick="openCheckoutModal()" class="btn btn-gold w-100 fw-bold">PROCEED TO CHECKOUT</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="data.js"></script>

    <script>
        let cart = [];
        let allProducts = [];
        let currentModalProductId = null;
        let currentModalQty = 1;
        const PRODUCT_DESCRIPTIONS = {
            'W001': 'ปืนไรเฟิลจู่โจม M4A1 Full Metal ระบบไฟฟ้า (AEG) ความแม่นยำสูง',
            'W002': 'ปืนพก Glock 19 Gen 5 ระบบแก๊ส (Gas Blowback) ขนาดกะทัดรัด',
            'W003': 'ปืนสไนเปอร์ L96 A1 ระบบชักยิง พร้อมกล้องสโคป',
            'A001': 'เสื้อเกราะ Plate Carrier Level 3 ผ้า Cordura 1000D',
            'A002': 'หมวกกันน็อค FAST Ballistic น้ำหนักเบา',
            'G001': 'กระเป๋าเป้ Tactical 45L จุของได้เยอะ กันน้ำ'
        };

        function getProductDescription(id, category) {
            if (PRODUCT_DESCRIPTIONS[id]) return PRODUCT_DESCRIPTIONS[id];
            switch(category) {
                case 'WEAPONS': return 'อาวุธยุทธวิธีคุณภาพสูง แม่นยำ ทนทาน';
                case 'ARMOR': return 'อุปกรณ์ป้องกันภัยส่วนบุคคล ออกแบบตามหลักสรีรศาสตร์';
                case 'GEAR': return 'อุปกรณ์เสริมเกรด Mil-Spec เพิ่มประสิทธิภาพภารกิจ';
                default: return 'สินค้าคุณภาพสูงจาก Tactical Ops';
            }
        }

        // --- CORE SYSTEM ---
        function initSystem() {
            checkAuth();

            if (typeof SYSTEM_DATA !== 'undefined' && SYSTEM_DATA.length > 0) {
                // แก้ไข: ใช้ข้อมูลจาก SYSTEM_DATA เท่านั้น ไม่มีการ Merge
                allProducts = SYSTEM_DATA; 
                localStorage.setItem('tactical_products', JSON.stringify(allProducts));
            } else {
                allProducts = JSON.parse(localStorage.getItem('tactical_products')) || [];
            }
            renderShop('ALL');
            const savedCart = sessionStorage.getItem('tactical_cart');
            if (savedCart) {
                cart = JSON.parse(savedCart);
                updateCartUI();
            }
        }

        // --- RENDER SHOP ---
        function renderShop(filter) {
            const grid = document.getElementById('galleryGrid');
            if (!grid) return;
            let filtered = allProducts;
            if (filter !== 'ALL') filtered = allProducts.filter(p => p.category === filter);
            if(filtered.length === 0) {
                grid.innerHTML = '<div class="col-12 text-center text-muted py-5"><h4>NO INTEL FOUND</h4></div>';
                return;
            }
            grid.innerHTML = filtered.map(p => `
                <div class="col-md-6 col-lg-4 animate-item">
                    <div class="card tactical-card h-100 text-white">
                        <div class="position-relative overflow-hidden group-hover-zoom">
                            <img src="${p.image}" class="card-img-top" alt="${p.name}" onerror="this.src='https://via.placeholder.com/400x400?text=NO+IMAGE'" style="cursor: pointer;" onclick="viewProduct('${p.id}')">
                            <div class="position-absolute top-0 end-0 m-2"><span class="badge bg-dark border border-warning text-warning">${p.category}</span></div>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title font-tech fw-bold text-uppercase text-truncate" style="cursor: pointer;" onclick="viewProduct('${p.id}')">${p.name}</h5>
                            <div class="mt-auto d-flex justify-content-between align-items-center">
                                <h4 class="text-gold mb-0 font-monospace">฿${p.price.toLocaleString()}</h4>
                                <div>
                                    <button class="btn btn-outline-light btn-sm me-1" onclick="viewProduct('${p.id}')"><i class="fas fa-eye"></i></button>
                                    <button class="btn btn-outline-warning btn-sm" onclick="quickAdd('${p.id}')"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`).join('');
        }
        function filterShop(cat, btn) {
            document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderShop(cat);
        }

        // --- MODAL ---
        function viewProduct(id) {
            const product = allProducts.find(p => p.id === id);
            if (!product) return;
            currentModalProductId = id;
            currentModalQty = 1;
            document.getElementById('modalImg').src = product.image;
            document.getElementById('modalName').innerText = product.name;
            document.getElementById('modalCat').innerText = product.category;
            document.getElementById('modalId').innerText = product.id;
            document.getElementById('modalPrice').innerText = '฿' + product.price.toLocaleString();
            document.getElementById('modalDesc').innerText = getProductDescription(product.id, product.category);
            updateModalQtyDisplay();
            loadComments(id);
            new bootstrap.Modal(document.getElementById('productModal')).show();
        }
        function adjustModalQty(change) {
            const newQty = currentModalQty + change;
            if (newQty >= 1) {
                currentModalQty = newQty;
                updateModalQtyDisplay();
            }
        }
        function updateModalQtyDisplay() { document.getElementById('modalQtyDisplay').innerText = currentModalQty; }
        function addToCartFromModal() {
            if (currentModalProductId) {
                addToCart(currentModalProductId, currentModalQty);
                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: `ADDED ${currentModalQty} UNITS`, showConfirmButton: false, timer: 1500, background:'#000', color:'#fbbf24' });
            }
        }
        function quickAdd(id) {
            addToCart(id, 1);
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'ADDED TO LOADOUT', showConfirmButton: false, timer: 1500, background:'#000', color:'#fbbf24' });
        }

        // --- COMMENTS ---
        function loadComments(productId) {
            const allComments = JSON.parse(localStorage.getItem('tactical_comments')) || {};
            const list = document.getElementById('commentsList');
            const productComments = allComments[productId] || [];
            list.innerHTML = productComments.length === 0 ? '<div class="text-muted small fst-italic">No intel reports yet.</div>' : 
                productComments.map(c => `<div class="comment-box"><div class="d-flex justify-content-between"><span class="comment-user"><i class="fas fa-user-secret me-1"></i> ${c.user}</span><span class="comment-date">${c.date}</span></div><div class="comment-text mt-1">${c.text}</div></div>`).join('');
        }
        function postComment() {
            const input = document.getElementById('commentInput');
            const text = input.value.trim();
            if (!text || !currentModalProductId) return;
            const allComments = JSON.parse(localStorage.getItem('tactical_comments')) || {};
            if (!allComments[currentModalProductId]) allComments[currentModalProductId] = [];
            allComments[currentModalProductId].unshift({ user: 'Operative', text: text, date: new Date().toLocaleDateString('th-TH') + ' ' + new Date().toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'}) });
            localStorage.setItem('tactical_comments', JSON.stringify(allComments));
            input.value = '';
            loadComments(currentModalProductId);
        }

        // --- CART ---
        function addToCart(id, qty = 1) {
            const product = allProducts.find(p => p.id === id);
            if (!product) return;
            const existing = cart.find(i => i.id === id);
            if (existing) existing.quantity += qty;
            else cart.push({ ...product, quantity: qty });
            updateCartUI();
        }
        function updateCartUI() {
            sessionStorage.setItem('tactical_cart', JSON.stringify(cart));
            const badge = document.getElementById('cartBadgeFloat');
            const list = document.getElementById('cartItems');
            const totalEl = document.getElementById('cartTotal');
            const totalQty = cart.reduce((sum, i) => sum + i.quantity, 0);
            const totalCost = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
            if(badge) { badge.innerText = totalQty; badge.style.display = totalQty > 0 ? 'block' : 'none'; }
            if(totalEl) totalEl.innerText = '฿' + totalCost.toLocaleString();
            list.innerHTML = cart.length === 0 ? '<div class="text-center text-muted py-4"><i class="fas fa-box-open fa-2x mb-2"></i><br>EMPTY LOADOUT</div>' : 
                cart.map(item => `<div class="d-flex justify-content-between align-items-center mb-3 border-bottom border-secondary pb-2"><div class="d-flex align-items-center"><img src="${item.image}" style="width: 50px; height: 50px; object-fit: cover;" class="rounded border border-secondary me-2"><div><div class="font-tech small text-white text-truncate" style="max-width: 150px;">${item.name}</div><div class="text-muted small">x${item.quantity} @ ฿${item.price}</div></div></div><div class="d-flex align-items-center gap-2"><button class="btn btn-sm btn-outline-secondary" onclick="updateCartQty('${item.id}', -1)">-</button><span>${item.quantity}</span><button class="btn btn-sm btn-outline-warning" onclick="updateCartQty('${item.id}', 1)">+</button><button class="btn btn-sm text-danger ms-1" onclick="removeFromCart('${item.id}')"><i class="fas fa-trash"></i></button></div></div>`).join('');
        }
        function updateCartQty(id, change) {
            const item = cart.find(x => x.id === id);
            if(item) {
                if(change === 1) item.quantity++;
                if(change === -1 && item.quantity > 1) item.quantity--;
                updateCartUI();
            }
        }
        function removeFromCart(id) { cart = cart.filter(i => i.id !== id); updateCartUI(); }

        // --- CHECKOUT LOGIC ---
        function openCheckoutModal() {
            if(cart.length === 0) return Swal.fire('Error', 'Cart is empty', 'error');
            
            const session = sessionStorage.getItem('tactical_session');
            if(!session) {
                 return Swal.fire({
                    icon: 'warning', title: 'ACCESS DENIED', 
                    text: 'Please LOGIN to verify your identity before requisition.',
                    background: '#000', color: '#fff',
                    showCancelButton: true, confirmButtonText: 'LOGIN NOW', confirmButtonColor: '#fbbf24'
                }).then((res) => {
                    if(res.isConfirmed) window.location.href = 'login.html';
                });
            }

            const user = JSON.parse(session);
            document.getElementById('cName').value = user.name || '';
            document.getElementById('cPhone').value = user.phone || '';
            document.getElementById('cAddr').value = user.address || '';

            bootstrap.Offcanvas.getInstance(document.getElementById('cartOffcanvas')).hide();
            const totalCost = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
            document.getElementById('checkoutTotal').innerText = '฿' + totalCost.toLocaleString();
            new bootstrap.Modal(document.getElementById('checkoutModal')).show();
        }

        function togglePayment() {
            const method = document.querySelector('input[name="paymentMethod"]:checked').value;
            const qrDisplay = document.getElementById('qrDisplay');
            if (method === 'QR') {
                qrDisplay.style.display = 'block';
            } else {
                qrDisplay.style.display = 'none';
            }
        }

        function confirmOrder() {
            const name = document.getElementById('cName').value.trim();
            const phone = document.getElementById('cPhone').value.trim();
            const addr = document.getElementById('cAddr').value.trim();
            const payment = document.querySelector('input[name="paymentMethod"]:checked').value;

            if (!name || !phone || !addr) {
                return Swal.fire({ icon: 'error', title: 'MISSING INTEL', text: 'Please fill in all shipping details.', background: '#000', color: '#fff' });
            }

            Swal.fire({
                title: 'CONFIRM REQUISITION?',
                text: "Proceed with this order?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#fbbf24',
                background: '#000', color: '#fff'
            }).then((result) => {
                if (result.isConfirmed) {
                    const orders = JSON.parse(localStorage.getItem('tactical_orders')) || [];
                    const newOrder = {
                        id: 'ORD-' + Date.now(),
                        total: cart.reduce((sum, i) => sum + (i.price * i.quantity), 0),
                        items: cart,
                        status: 'PENDING',
                        date: new Date().toISOString(),
                        customerName: name,
                        customerPhone: phone,
                        customerAddress: addr,
                        paymentMethod: payment
                    };
                    orders.push(newOrder);
                    localStorage.setItem('tactical_orders', JSON.stringify(orders));
                    
                    cart = [];
                    updateCartUI();
                    bootstrap.Modal.getInstance(document.getElementById('checkoutModal')).hide();
                    
                    Swal.fire({
                        icon: 'success', 
                        title: 'ORDER DISPATCHED', 
                        html: `Order <b>#${newOrder.id}</b> confirmed.<br>We will ship to: ${addr}`,
                        background: '#000', color: '#fbbf24'
                    });
                }
            });
        }
    </script>
</body>
</html>